<html>
    <head>
        <title>Bridge UI Widgets</title>
        <script src="web3.min.js"></script>
        <script src="erc20_bridge_abi.js"></script>
        <script src="vusd_token_abi.js"></script>
        <script >
            /*


            // TEST ADDRESSES, UNKNOWN PK, NOT REAL TOKENS
            let test_tokens = ["0x5ab635fa772ac133f6068dc6940b1ee22e4cc9f8",
                "0x2157ec9c2c8e0ca1995ddb5d515884118e865088",
                "0x27d1cab96e31733b807c0a8324fd9205af2597c9",
                "0xae3a4fc07275dbbc34a3894301335c3ef51f6571",
                "0xa9411f354f9b31fca35aeea10477753c3e5acf0d",
                "0x77b71e8f3da1dc52cd2643abcd01916d244a30e0",
                "0xb35ec78b981455d055d76ce4cf61da42483837b5",
                "0x14b162d1f892cb8855a01054dfc8ac3794252212",
                "0x1b9ff35ae0ff66e1eecb864c56c1a9cbf338cd7a",
                "0x994f3cc3e5a5ae9887328b0a0b522ab50884922c"];
             */


            //ganache-cli -m "cherry manage trip absorb logic half number test shed logic purpose rifle"
            let erc20_bridge_address = "0x3EA59801698c6820328597F26d29fC3EaAa17AcA";
            let vusd_token_address = "0x0858D9BD11A4F6Bae8b979402550CA6c6ddB8332";
            async function init_web3 (){
                if (typeof web3 !== 'undefined') {
                    console.log("using metamask")
                    // If a web3 instance is already provided by Meta Mask.
                    window.web3Provider = web3.currentProvider;
                    window.web3 = new Web3(web3.currentProvider);
                } else {
                    console.log("using localhost")
                    // Specify default instance if no web3 instance provided
                    window.web3Provider = new Web3.providers.HttpProvider('http://localhost:8545');
                    window.web3 = new Web3(window.web3Provider);
                }

                //console.log("accounts: ");
                window.accounts = await web3.eth.getAccounts();
                //console.log(window.accounts[0])

                initContracts();

            }
            async function initContracts( ) {

                window.erc20_bridge_instance = new window.web3.eth.Contract(erc20_bridge_abi, erc20_bridge_address);
                window.vusd_test_token_instance = new window.web3.eth.Contract(vusd_token_abi, vusd_token_address);

                //console.log("asset whitelisted")
                //console.log(await window.erc20_bridge_instance.methods.is_asset_whitelisted(token_address, 0).call());
                let vusd_balance =  await window.vusd_test_token_instance.methods.balanceOf(window.accounts[0]).call();
                document.getElementById("deposit_vusd_balance").innerText = vusd_balance;
                document.getElementById("faucet_vusd_balance").innerText = vusd_balance;
                let vusd_on_bridge = await window.vusd_test_token_instance.methods.balanceOf(erc20_bridge_address).call();
                document.getElementById("withdrawal_token_available").innerText = vusd_on_bridge;

            }

            init_web3()

            async function whitelist_asset(){


                let to_whitelist = document.getElementById("token_address").value;
                console.log(to_whitelist);
                //TODO: sanitize to_whitelist and check if ERC20
                fetch('http://localhost:4000/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify(
                        {
                            query: "{ get_multisig_whitelist_asset (to_whitelist:\""+ to_whitelist+"\") {signatures,nonce} }",
                        })
                })
                    .then(r => r.json())
                    .then(async get_multisig_whitelist_asset_result =>{
                        let result_data = get_multisig_whitelist_asset_result.data.get_multisig_whitelist_asset;
                        console.log(result_data)

                        let whitelist_asset_receipt = await window.erc20_bridge_instance.methods.whitelist_asset( to_whitelist, 0, result_data.nonce, result_data.signatures)
                            .send({from: window.accounts[0]})

                        console.log(whitelist_asset_receipt)
                        console.log("~~~~~~~~~~~~~~~~~~~~EVENTS")
                        let result_event = whitelist_asset_receipt.events.Asset_Whitelisted.returnValues;
                        console.log("Asset Whitelisted")
                        console.log( "asset_source: "+ result_event.asset_source)
                        console.log( "asset_id: "+ result_event.asset_id)
                        console.log( "nonce: "+ result_event.nonce)
                        //submit to window.erc20_bridge_instance.methods
                        // .whitelist_asset(to_whitelist, 0, result_data.nonce, result_data.signatures)
                        // .send({from: window.accounts[0] })
                        document.getElementById("whitelist_results").value = "Asset Whitelisted \n"
                        + "asset_source: " + result_event.asset_source + "\n"
                        + "asset_id: " + result_event.asset_id + "\n"
                        + "nonce: " + result_event.nonce
                        ;

                    } );
            }

            async function deposit_token(){
                //get token amt
                let token_amount = document.getElementById("deposit_token_amount").value;
                let vega_public_key = document.getElementById("deposit_vega_public_key").value;
                //TODO: sanitize

                let approval_receipt = await window.vusd_test_token_instance.methods.approve(erc20_bridge_address, token_amount).send({from: window.accounts[0]});
                let deposit_receipt = await window.erc20_bridge_instance.methods.deposit_asset(vusd_token_address, 0, token_amount, vega_public_key).send({from: window.accounts[0]});
                let result_event = deposit_receipt.events.Asset_Deposited.returnValues;
                document.getElementById("deposit_results").value = "Asset Deposited \n"
                    + "user_address: " + result_event.user_address + "\n"
                    + "asset_source: " + result_event.asset_source + "\n"
                    + "asset_id: " + result_event.asset_id + "\n"
                    + "amount: " + result_event.amount + "\n"
                    + "vega_public_key: " + result_event.vega_public_key + "\n"
                ;
            }

            //console.log(web3)
            async function vusd_faucet(){
                let faucet_receipt = await window.vusd_test_token_instance.methods.faucet().send({from: window.accounts[0]});
                let result_event = faucet_receipt.events.Transfer.returnValues;
                document.getElementById("faucet_results").value = "Transfer \n"
                    + "from: " + result_event.from + "\n"
                    + "to: " + result_event.to + "\n"
                    + "value: " + result_event.value + "\n"
            }

            async function withdraw_vusd(){
                let token_address = vusd_token_address;
                let token_amount = document.getElementById("withdrawal_token_requested").value;
                let withdrawal_address = window.accounts[0];
                let bridge_address = erc20_bridge_address;

                fetch('http://localhost:4000/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify(
                        {
                            query: "{ get_multisig_withdrawal (token_address:\""+ token_address+"\", token_amount:\""+token_amount+"\", withdrawal_address: \""+withdrawal_address+"\", bridge_address:\""+bridge_address+"\") {signatures,nonce} }",
                        })
                })
                    .then(r => r.json())
                    .then(async get_multisig_withdrawal_result =>{

                        //submit withdrawal
                        console.log("WITHDRAWAL RESULTS: ")
                        console.log(get_multisig_withdrawal_result)
                        let result = get_multisig_withdrawal_result.data.get_multisig_withdrawal;
                        console.log(result)
                        let withdrawal_receipt = await window.erc20_bridge_instance.methods.withdraw_asset(token_address, 0, token_amount, result.nonce, result.signatures).send({from: window.accounts[0]});

                        let result_event = withdrawal_receipt.events.Asset_Withdrawn.returnValues;

                        document.getElementById("withdrawal_results").value = "Asset Withdrawn \n"
                            + "user_address: " + result_event.user_address + "\n"
                            + "asset_source: " + result_event.asset_source + "\n"
                            + "amount: " + result_event.amount + "\n"
                            + "nonce: " + result_event.nonce + "\n"
                    });

            }

            async function add_signer() {
                let signer_address = document.getElementById("add_signer_address").value;


            }

        </script>
        <style>
            table{
                border: thin black solid;
                width: 400px;
                float: left;
            }
        </style>
    </head>
    <body>
    <table>

        <tbody>
        <tr><td colspan="2"><h2 style="text-align: center">Whitelist Token</h2></td></tr>
        <tr><td>Token Contract Address: </td><td><input name="token_address" id="token_address" value="0x5ab635fa772ac133f6068dc6940b1ee22e4cc9f8" /></td></tr>

        <tr><td></td>
            <td><button onclick="whitelist_asset()"> Whitelist Token</button></td>
        </tr>
        <tr><td>Result:</td></tr>
        <tr><td colspan="2"><textarea rows="10" style="width: 100%" id="whitelist_results"></textarea></td></tr>
        </tbody>
    </table>

    <table>
        <tbody>
        <tr><td colspan="2"><h2 style="text-align: center">Deposit VUSD</h2></td></tr>
        <tr><td>Vega Public Address: </td><td><input name="deposit_vega_public_key" id="deposit_vega_public_key" value="0x00" /></td></tr>
        <tr><td>VUSD Balance: </td><td><span id="deposit_vusd_balance"></span></td></tr>
        <tr><td>Deposit Amount: </td><td><input name="deposit_token_amount" id="deposit_token_amount" value="1000000000000000000" /></td></tr>

        <tr><td></td>
            <td><button onclick="deposit_token()"> Deposit VUSD Token</button></td>
        </tr>
        <tr><td>Result:</td></tr>
        <tr><td colspan="2"><textarea rows="10" style="width: 100%" id="deposit_results"></textarea></td></tr>
        </tbody>
    </table>


    <table>
        <tbody>
        <tr><td colspan="2"><h2 style="text-align: center">Withdrawal VUSD</h2></td></tr>
        <tr><td>Token Available: </td><td><span id="withdrawal_token_available">0</span> VUSD</td></tr>
        <tr><td>Token Requested: </td><td><input id="withdrawal_token_requested" value="1000000000000000000" /></td></tr>

        <tr><td></td>
            <td><button onclick="withdraw_vusd()"> Withdraw VUSD</button></td>
        </tr>
        <tr><td>Result:</td></tr>
        <tr><td colspan="2"><textarea rows="10" style="width: 100%" id="withdrawal_results"></textarea></td></tr>
        </tbody>
    </table>


    <table>
        <tbody>
        <tr><td colspan="2"><h2 style="text-align: center">VUSD Faucet</h2></td></tr>
        <tr><td>Token Balance: </td><td><span id="faucet_vusd_balance">0</span> VUSD</td></tr>
        <tr><td></td>
            <td><button onclick="vusd_faucet()"> Get VUSD</button></td>
        </tr>
        <tr><td>Result:</td></tr>
        <tr><td colspan="2"><textarea rows="10" style="width: 100%" id="faucet_results"></textarea></td></tr>
        </tbody>
    </table>

    <table>
        <tbody>
        <tr><td colspan="2"><h2 style="text-align: center">Add Signer (NOT YET IMPLEMENTED)</h2></td></tr>
        <tr><td>Signer Address: </td><td><input id="add_signer_address" value="0x00..." /></td></tr>
        <tr><td></td>
            <td><button onclick="add_signer()"> Add Signer</button></td>
        </tr>
        <tr><td>Result:</td></tr>
        <tr><td colspan="2"><textarea rows="10" style="width: 100%" id="results"></textarea></td></tr>
        </tbody>
    </table>

    </body>
</html>